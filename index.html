<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice & Quote Generator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX support in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PapaParse for CSV Processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        /* Custom Print Styles */
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-break-inside-avoid { break-inside: avoid; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Application Code -->
    <script type="text/babel" data-type="module">
        // --- Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- Icons ---
        const Icon = ({ d, size = 16, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d={d} />
            </svg>
        );

        const Plus = (props) => <Icon d="M5 12h14M12 5v14" {...props} />;
        const Trash2 = (props) => <Icon d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" {...props} />;
        const Printer = (props) => <Icon d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2M6 14h12v8H6z" {...props} />;
        const Save = (props) => <Icon d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8" {...props} />;
        const LogIn = (props) => <Icon d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3" {...props} />;
        const LogOut = (props) => <Icon d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" {...props} />;
        const Paperclip = (props) => <Icon d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" {...props} />;
        const FileText = (props) => <Icon d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z M14 2v6h6" {...props} />;
        const ExternalLink = (props) => <Icon d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3" {...props} />;
        const UploadCloud = (props) => <Icon d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242M12 12v9M16 16l-4-4-4 4" {...props} />;
        const Search = (props) => <Icon d="M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16zM21 21l-4.35-4.35" {...props} />;
        const User = (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const Loader = (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`animate-spin ${props.className}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const FileCheck = (props) => <Icon d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z M10 13l2 2 4-4" {...props} />;
        const ArrowRight = (props) => <Icon d="M5 12h14M12 5l7 7-7 7" {...props} />;
        const FilePlus = (props) => <Icon d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z M12 11v6 M9 14h6" {...props} />;


        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAicK1hgi93n0FdhQhEStj1J51NTrmM6fU",
            authDomain: "invoice-generator-478917.firebaseapp.com",
            projectId: "invoice-generator-478917",
            storageBucket: "invoice-generator-478917.firebasestorage.app",
            messagingSenderId: "422967457046",
            appId: "1:422967457046:web:4bb10e870bf42c48f34c37",
            measurementId: "G-7936FZBQN3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();
        const APP_ID = "invoice-generator-478917";

        const { useState, useEffect, useRef } = React;

        function InvoiceApp() {
            // --- User & App State ---
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [saveStatus, setSaveStatus] = useState('');
            
            // --- Database & Search State ---
            const [customerDB, setCustomerDB] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [showResults, setShowResults] = useState(false);
            const csvInputRef = useRef(null);

            // --- Invoice/Quote Mode State ---
            const [docType, setDocType] = useState('invoice'); // 'invoice' or 'quote'

            // --- Invoice Data State ---
            const [invoiceDate, setInvoiceDate] = useState(new Date().toISOString().substr(0, 10));
            const [jobNo, setJobNo] = useState('');
            const [woNo, setWoNo] = useState('');
            
            const [serviceType, setServiceType] = useState({
                serviceCall: false, plannedMaintenance: false, afterHours: false,
                shopWork: false, regular: false, warranty: false,
            });

            const [customerInfo, setCustomerInfo] = useState({
                name: '', billingAddress: '', phone: '', cell: '', email: '',
                complaint: '', orderedBy: '', unitAddress: '', unitPhone: '',
                hasServiceAgreement: false
            });

            const [units, setUnits] = useState([{ id: 1, unitNo: '', make: '', model: '', serial: '', location: '' }]);
            const [technicians, setTechnicians] = useState([{ id: 1, name: '', enRoute: '', clockIn: '', clockOut: '' }]);

            const [descriptionOfWork, setDescriptionOfWork] = useState('');
            const [recommendations, setRecommendations] = useState('');
            const [items, setItems] = useState([{ id: 1, qty: 1, description: 'Service Charge', price: 0 }]);
            const [taxRate, setTaxRate] = useState(0.06);
            const [attachments, setAttachments] = useState([]);
            const fileInputRef = useRef(null);

            const subtotal = items.reduce((sum, item) => sum + (item.qty * item.price), 0);
            const tax = subtotal * taxRate;
            const total = subtotal + tax;

            // --- Text Constants based on Mode ---
            const TEXTS = {
                title: docType === 'invoice' ? 'SERVICE INVOICE' : 'PROPOSAL / QUOTE',
                dateLabel: docType === 'invoice' ? 'DATE' : 'QUOTE DATE',
                woLabel: docType === 'invoice' ? 'WO #' : 'REF #',
                ackTitle: docType === 'invoice' ? 'WORK ACKNOWLEDGMENT' : 'PROPOSAL ACCEPTANCE',
                ackBody: docType === 'invoice' 
                    ? "I have the authority to order the work outlined above which has been satisfactorily completed. I agree the seller retains title to equipment/materials furnished until final payment is made. If payment is not made as agreed, Seller can remove said equipment /materials at seller's expense. Any damage from said removal shall not be the responsibility of seller."
                    : "The above prices, specifications, and conditions are satisfactory and are hereby accepted. You are authorized to do the work as specified. Payment will be made as outlined above.",
                warrantyTitle: docType === 'invoice' ? 'Limited Warranty in Fine Print' : 'Proposal Terms & Conditions',
                warrantyBody: docType === 'invoice'
                    ? "Services listed are covered by a Limited Warranty from the Manufacturer and Mechanical Temp. The Limited Warranty covers defects in materials and workmanship for the duration outlined on the invoice. Mechanical Temp is not responsible for any materials or services installed previously or after services covered on this invoice. Mechanical Temp is not responsible for any structural or material damages that occur due to failures with materials/workmanship provided, as well as, for services provided as a courtesy to the client (not charged or paid for). Mechanical Temp is not responsible for any failures or damages due to Acts of God, other individuals, or other companies performing work on the service area."
                    : "This proposal may be withdrawn by us if not accepted within 30 days. All work to be completed in a workmanlike manner according to standard practices. Any alteration or deviation from above specifications involving extra costs will be executed only upon written orders, and will become an extra charge over and above the estimate. All agreements contingent upon strikes, accidents or delays beyond our control. Owner to carry fire, tornado and other necessary insurance."
            };

            // --- Effects ---
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                    if (currentUser) {
                        await loadInvoiceData(currentUser.uid);
                        await loadCustomerDB(currentUser.uid); 
                    }
                });
                return () => unsubscribe();
            }, []);

            // --- Database Logic ---
            const handleCSVUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (!user) { alert("Please login to save the database."); return; }

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: async (results) => {
                        const rawData = results.data;
                        const newEntries = rawData.map(row => ({
                            name: row['Bill To'] || row['Customer'] || '',
                            locationName: row['Customer'] || '',
                            address: row['Service Address'] || '',
                            jobNo: row['Job No.'] || '',
                            searchStr: `${row['Bill To']} ${row['Customer']} ${row['Service Address']} ${row['Job No.']}`.toLowerCase()
                        })).filter(item => item.name || item.address);

                        const dbMap = new Map(customerDB.map(item => [item.jobNo || item.searchStr, item]));
                        newEntries.forEach(entry => {
                            const key = entry.jobNo || entry.searchStr;
                            dbMap.set(key, entry);
                        });
                        const mergedList = Array.from(dbMap.values());

                        setCustomerDB(mergedList);
                        await saveCustomerDB(mergedList, user.uid);
                        alert(`Database merged successfully! Total Records: ${mergedList.length}`);
                    },
                    error: (err) => {
                        console.error("CSV Error:", err);
                        alert("Error reading CSV file.");
                    }
                });
                if(csvInputRef.current) csvInputRef.current.value = '';
            };

            const saveCustomerDB = async (data, uid) => {
                try {
                    const docRef = doc(db, 'artifacts', APP_ID, 'users', uid, 'data', 'customer_db');
                    await setDoc(docRef, { list: data, lastUpdated: new Date().toISOString() });
                } catch (error) {
                    console.error("Error saving DB:", error);
                    alert("Error saving database to cloud.");
                }
            };

            const loadCustomerDB = async (uid) => {
                try {
                    const docRef = doc(db, 'artifacts', APP_ID, 'users', uid, 'data', 'customer_db');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        setCustomerDB(docSnap.data().list || []);
                    }
                } catch (error) { console.error("Error loading DB:", error); }
            };

            const handleSearchResultClick = (record) => {
                setJobNo(record.jobNo || '');
                setCustomerInfo(prev => ({
                    ...prev,
                    name: record.name,
                    unitAddress: record.address,
                    billingAddress: prev.billingAddress || '',
                }));
                setUnits(prev => {
                    const newUnits = [...prev];
                    if (newUnits.length > 0) {
                        newUnits[0].location = record.locationName;
                    }
                    return newUnits;
                });
                setSearchQuery('');
                setShowResults(false);
            };

            // --- Invoice Data Persistence ---
            const saveInvoiceData = async () => {
                if (!user) return;
                setSaveStatus('Saving...');
                const invoiceData = {
                    docType, // Save document type
                    invoiceDate, jobNo, woNo, serviceType, customerInfo, 
                    units, technicians, descriptionOfWork, recommendations, items, taxRate,
                    lastUpdated: new Date().toISOString()
                };
                try {
                    const docRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'data', 'current_invoice');
                    await setDoc(docRef, invoiceData);
                    setSaveStatus('Saved!');
                    setTimeout(() => setSaveStatus(''), 2000);
                } catch (error) { console.error(error); setSaveStatus('Error'); }
            };

            const loadInvoiceData = async (uid) => {
                try {
                    const docRef = doc(db, 'artifacts', APP_ID, 'users', uid, 'data', 'current_invoice');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.docType) setDocType(data.docType);
                        if (data.invoiceDate) setInvoiceDate(data.invoiceDate);
                        if (data.jobNo) setJobNo(data.jobNo);
                        if (data.woNo) setWoNo(data.woNo);
                        if (data.serviceType) setServiceType(data.serviceType);
                        if (data.customerInfo) setCustomerInfo(data.customerInfo);
                        if (data.units) setUnits(data.units); else if (data.unitInfo) setUnits([{...data.unitInfo, id:1}]);
                        if (data.technicians) setTechnicians(data.technicians); else if (data.techInfo) setTechnicians([{...data.techInfo, id:1}]);
                        if (data.descriptionOfWork) setDescriptionOfWork(data.descriptionOfWork);
                        if (data.recommendations) setRecommendations(data.recommendations);
                        if (data.items) setItems(data.items);
                        if (data.taxRate) setTaxRate(data.taxRate);
                    }
                } catch (error) { console.error(error); }
            };

            // --- Link/Convert Handler ---
            const handleConvertToInvoice = () => {
                if (confirm("Create Invoice from this Quote? \n\nThis will switch to Invoice mode and update the date to today. All information will be preserved.")) {
                    setDocType('invoice');
                    setInvoiceDate(new Date().toISOString().substr(0, 10)); // Update date to today
                }
            };

            const handleConvertToQuote = () => {
                if (confirm("Create Quote from this Invoice? \n\nThis will switch to Quote mode and update the date to today. All information (customer, unit, etc.) will be preserved.")) {
                    setDocType('quote');
                    setInvoiceDate(new Date().toISOString().substr(0, 10)); // Update date to today
                }
            };

            // --- Form Handlers ---
            const handleServiceTypeChange = (key) => setServiceType(prev => ({ ...prev, [key]: !prev[key] }));
            const handleCustomerChange = (e) => {
                const { name, value, type, checked } = e.target;
                setCustomerInfo(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            };
            const handleUnitChange = (id, field, value) => setUnits(prev => prev.map(u => u.id === id ? { ...u, [field]: value } : u));
            const addUnit = () => setUnits(prev => [...prev, { id: Date.now(), unitNo: '', make: '', model: '', serial: '', location: '' }]);
            const removeUnit = (id) => { if (units.length > 1) setUnits(prev => prev.filter(u => u.id !== id)); };
            const handleTechChange = (id, field, value) => setTechnicians(prev => prev.map(t => t.id === id ? { ...t, [field]: value } : t));
            const addTech = () => setTechnicians(prev => [...prev, { id: Date.now(), name: '', enRoute: '', clockIn: '', clockOut: '' }]);
            const removeTech = (id) => { if (technicians.length > 1) setTechnicians(prev => prev.filter(t => t.id !== id)); };
            const handleItemChange = (id, field, value) => setItems(prev => prev.map(item => item.id === id ? { ...item, [field]: value } : item));
            const addItem = () => setItems(prev => [...prev, { id: Date.now(), qty: 1, description: '', price: 0 }]);
            const removeItem = (id) => { if (items.length > 1) setItems(prev => prev.filter(item => item.id !== id)); };
            
            const handleLogin = async () => { try { await signInWithPopup(auth, googleProvider); } catch (e) { console.error(e); alert(e.message); } };
            const handleLogout = async () => { try { await signOut(auth); setSaveStatus(''); setCustomerDB([]); } catch (e) { console.error(e); } };
            const handlePrint = () => window.print();

            const handleFileSelect = (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onloadend = () => setAttachments(prev => [...prev, { id: Date.now()+Math.random(), name: file.name, type: file.type, data: reader.result }]);
                    reader.readAsDataURL(file);
                });
                if(fileInputRef.current) fileInputRef.current.value = '';
            };
            const removeAttachment = (id) => setAttachments(prev => prev.filter(att => att.id !== id));

            if (loading) return <div className="flex items-center justify-center min-h-screen text-blue-600"><Loader /></div>;

            return (
                <div className="min-h-screen bg-gray-100 p-4 md:p-8 font-sans print:bg-white print:p-0">
                
                {/* Top Controls */}
                <div className="no-print max-w-[850px] mx-auto mb-6 bg-white p-4 rounded-lg shadow flex flex-col gap-4">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h1 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                {docType === 'invoice' ? 'Invoice Generator' : 'Quote Generator'}
                            </h1>
                            {user && <p className="text-xs text-gray-500 flex items-center gap-1"><User size={10}/> {user.email}</p>}
                        </div>

                        {/* MODE SWITCHER */}
                        <div className="flex items-center gap-2">
                            <div className="flex bg-gray-100 p-1 rounded-lg">
                                <button 
                                    onClick={() => setDocType('invoice')}
                                    className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${docType === 'invoice' ? 'bg-blue-600 text-white shadow' : 'text-gray-600 hover:text-gray-800'}`}
                                >
                                    INVOICE
                                </button>
                                <button 
                                    onClick={() => setDocType('quote')}
                                    className={`px-4 py-1.5 text-sm font-bold rounded-md transition-all ${docType === 'quote' ? 'bg-blue-600 text-white shadow' : 'text-gray-600 hover:text-gray-800'}`}
                                >
                                    QUOTE
                                </button>
                            </div>
                            
                            {/* CONVERT BUTTON (Quote -> Invoice) */}
                            {docType === 'quote' && (
                                <button 
                                    onClick={handleConvertToInvoice}
                                    className="flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded text-xs transition-colors shadow-sm font-bold"
                                    title="Convert this Quote to an Invoice"
                                >
                                    <ArrowRight size={14} /> Make Invoice
                                </button>
                            )}

                            {/* CONVERT BUTTON (Invoice -> Quote) */}
                            {docType === 'invoice' && (
                                <button 
                                    onClick={handleConvertToQuote}
                                    className="flex items-center gap-2 bg-purple-500 hover:bg-purple-600 text-white px-3 py-1.5 rounded text-xs transition-colors shadow-sm font-bold"
                                    title="Create a Quote from this Invoice"
                                >
                                    <FilePlus size={14} /> Make Quote
                                </button>
                            )}
                        </div>

                        <div className="flex flex-wrap items-center gap-2">
                            {!user ? (
                                <button onClick={handleLogin} className="flex items-center gap-2 bg-gray-800 text-white px-3 py-1.5 rounded text-xs"><LogIn size={14} /> Login</button>
                            ) : (
                                <>
                                    <label className="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded text-xs cursor-pointer transition-colors">
                                        <UploadCloud size={14} /> Update DB
                                        <input ref={csvInputRef} type="file" accept=".csv" onChange={handleCSVUpload} className="hidden" />
                                    </label>
                                    <button onClick={saveInvoiceData} className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-xs transition-colors">
                                        <Save size={14} /> {saveStatus || "Save"}
                                    </button>
                                    <button onClick={handleLogout} className="flex items-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1.5 rounded text-xs transition-colors">
                                        <LogOut size={14} /> Logout
                                    </button>
                                </>
                            )}
                            <div className="h-5 w-px bg-gray-300 mx-1"></div>
                            <button onClick={handlePrint} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs transition-colors">
                                <Printer size={14} /> Print
                            </button>
                        </div>
                    </div>

                    {/* SEARCH BAR */}
                    {user && customerDB.length > 0 && (
                        <div className="relative w-full">
                            <div className="flex items-center border border-gray-300 rounded bg-gray-50 px-2 focus-within:ring-2 focus-within:ring-blue-500">
                                <Search size={16} className="text-gray-400 mr-2" />
                                <input 
                                    type="text" 
                                    placeholder="Quick Fill: Search by Customer Name, Store Name, or Address..." 
                                    className="w-full p-2 bg-transparent outline-none text-sm"
                                    value={searchQuery}
                                    onChange={(e) => { setSearchQuery(e.target.value); setShowResults(true); }}
                                    onFocus={() => setShowResults(true)}
                                />
                                {searchQuery && (
                                    <button onClick={() => setSearchQuery('')} className="text-gray-400 hover:text-gray-600 text-xs p-1">Clear</button>
                                )}
                            </div>
                            
                            {showResults && searchQuery.length > 1 && (
                                <div className="absolute z-50 w-full mt-1 bg-white border border-gray-200 shadow-lg rounded max-h-60 overflow-y-auto">
                                    {customerDB
                                        .filter(item => item.searchStr.includes(searchQuery.toLowerCase()))
                                        .slice(0, 10)
                                        .map((item, idx) => (
                                            <div 
                                                key={idx} 
                                                className="p-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-0"
                                                onClick={() => handleSearchResultClick(item)}
                                            >
                                                <div className="font-bold text-gray-800">{item.locationName} <span className="text-gray-400 font-normal">({item.name})</span></div>
                                                <div className="text-xs text-gray-500">{item.address}</div>
                                            </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                </div>

                {/* Main Document Sheet */}
                <div className="max-w-[850px] mx-auto bg-white shadow-xl print:shadow-none p-8 print:p-0 text-sm md:text-base print:text-xs leading-tight">
                    
                    {/* Header */}
                    <div className="border-b-2 border-black pb-4 mb-4">
                        <div className="flex justify-between items-start">
                            <div className="w-1/2">
                                <img src="https://imageview.replit.app/objects/uploads/d16ab63e-1d1e-4b8f-863c-67e66e4894fc" alt="Mechanical Temp Logo" className="max-w-[250px] h-auto object-contain mb-2" />
                                {/* DOCUMENT TYPE LABEL */}
                                <div className="text-2xl font-black tracking-widest text-gray-800 mt-2 uppercase border-2 border-black inline-block px-2">
                                    {TEXTS.title}
                                </div>
                            </div>
                            <div className="w-1/2 text-right text-sm">
                                <p className="font-bold">23093 Telegraph Rd</p>
                                <p>Southfield, MI 48033</p>
                                <p><span className="font-bold">Phone:</span> 313-282-4758</p>
                                <p><span className="font-bold">Email:</span> office@mechanicaltemp.com</p>
                                <p><span className="font-bold">Web:</span> www.mechanicaltemp.com</p>
                            </div>
                        </div>
                    </div>

                    {/* Job Details */}
                    <div className="flex flex-wrap border border-black mb-4">
                        <div className="w-1/4 p-2 border-r border-black">
                            <label className="block font-bold text-xs mb-1">JOB #</label>
                            <input type="text" value={jobNo} onChange={(e) => setJobNo(e.target.value)} className="w-full bg-blue-50 px-1 print:bg-transparent outline-none" />
                        </div>
                        <div className="w-1/4 p-2 border-r border-black">
                            <label className="block font-bold text-xs mb-1 uppercase">{TEXTS.dateLabel}</label>
                            <input type="date" value={invoiceDate} onChange={(e) => setInvoiceDate(e.target.value)} className="w-full bg-blue-50 px-1 print:bg-transparent outline-none" />
                        </div>
                        <div className="w-1/4 p-2 border-r border-black">
                            <label className="block font-bold text-xs mb-1 uppercase">{TEXTS.woLabel}</label>
                            <input type="text" value={woNo} onChange={(e) => setWoNo(e.target.value)} className="w-full bg-blue-50 px-1 print:bg-transparent outline-none" />
                        </div>
                        <div className="w-full flex flex-wrap text-xs font-bold border-t border-black">
                            <label className="w-1/3 p-2 flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={serviceType.serviceCall} onChange={() => handleServiceTypeChange('serviceCall')} /> SERVICE CALL</label>
                            <label className="w-1/3 p-2 flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={serviceType.plannedMaintenance} onChange={() => handleServiceTypeChange('plannedMaintenance')} /> PLANNED MAINTENANCE</label>
                            <label className="w-1/3 p-2 flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={serviceType.afterHours} onChange={() => handleServiceTypeChange('afterHours')} /> AFTER HOURS EMERGENCY</label>
                            <label className="w-1/3 p-2 flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={serviceType.shopWork} onChange={() => handleServiceTypeChange('shopWork')} /> SHOP WORK</label>
                            <label className="w-1/3 p-2 flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={serviceType.regular} onChange={() => handleServiceTypeChange('regular')} /> REGULAR</label>
                            <label className="w-1/3 p-2 flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={serviceType.warranty} onChange={() => handleServiceTypeChange('warranty')} /> WARRANTY</label>
                        </div>
                    </div>

                    {/* Customer & Service Info */}
                    <div className="flex flex-wrap border border-black mb-4">
                        <div className="w-1/2 border-r border-black">
                            <div className="p-2 border-b border-black">
                            <label className="font-bold text-xs block">CUSTOMER (BILL TO)</label>
                            <input name="name" value={customerInfo.name} onChange={handleCustomerChange} className="w-full bg-blue-50 px-1 print:bg-transparent outline-none font-bold" placeholder="" />
                            </div>
                            <div className="p-2 border-b border-black">
                            <label className="font-bold text-xs block">BILLING ADDRESS</label>
                            <textarea name="billingAddress" rows={2} value={customerInfo.billingAddress} onChange={handleCustomerChange} className="w-full bg-blue-50 px-1 print:bg-transparent outline-none resize-y" />
                            </div>
                            <div className="flex border-b border-black">
                            <div className="w-1/2 p-2 border-r border-black">
                                <label className="font-bold text-xs block">PHONE</label>
                                <input name="phone" value={customerInfo.phone} onChange={handleCustomerChange} className="w-full bg-blue-50 px-1 print:bg-transparent outline-none" />
                            </div>
                            <div className="w-1/2 p-2">
                                <label className="font-bold text-xs block">CELL</label>
                                <input name="cell" value={customerInfo.cell} onChange={handleCustomerChange} className="w-full bg-blue-50 px-1 print:bg-transparent outline-none" />
                            </div>
                            </div>
                            <div className="p-2">
                            <label className="font-bold text-xs block">EMAIL</label>
                            <input name="email" value={customerInfo.email} onChange={handleCustomerChange} className="w-full bg-blue-50 px-1 print:bg-transparent outline-none" />
                            </div>
                        </div>
                        <div className="w-1/2">
                            <div className="p-2 border-b border-black h-24">
                            <label className="font-bold text-xs block">COMPLAINT / REQUEST</label>
                            <textarea name="complaint" value={customerInfo.complaint} onChange={handleCustomerChange} className="w-full h-full bg-blue-50 px-1 print:bg-transparent outline-none resize-y" />
                            </div>
                            <div className="p-2 border-b border-black">
                            <label className="font-bold text-xs block">WORK ORDERED BY</label>
                            <input name="orderedBy" value={customerInfo.orderedBy} onChange={handleCustomerChange} className="w-full bg-blue-50 px-1 print:bg-transparent outline-none" />
                            </div>
                            <div className="p-2 border-b border-black">
                            <label className="font-bold text-xs block">ADDRESS OF UNIT</label>
                            <input name="unitAddress" value={customerInfo.unitAddress} onChange={handleCustomerChange} className="w-full bg-blue-50 px-1 print:bg-transparent outline-none" />
                            </div>
                            <div className="flex">
                            <div className="w-2/3 p-2 border-r border-black">
                                <label className="font-bold text-xs block">PHONE</label>
                                <input name="unitPhone" value={customerInfo.unitPhone} onChange={handleCustomerChange} className="w-full bg-blue-50 px-1 print:bg-transparent outline-none" />
                            </div>
                            <div className="w-1/3 p-2 flex flex-col items-center justify-center">
                                <label className="font-bold text-xs block text-center mb-1">SERVICE AGMT</label>
                                <input type="checkbox" name="hasServiceAgreement" checked={customerInfo.hasServiceAgreement} onChange={handleCustomerChange} className="w-5 h-5" />
                            </div>
                            </div>
                        </div>
                    </div>

                    {/* Unit Info */}
                    <div className="mb-4 border border-black">
                        <div className="flex bg-gray-200 text-xs font-bold border-b border-black print:bg-gray-100">
                            <div className="w-1/6 p-1 border-r border-black">UNIT #</div>
                            <div className="w-1/6 p-1 border-r border-black">MAKE</div>
                            <div className="w-1/6 p-1 border-r border-black">MODEL</div>
                            <div className="w-1/4 p-1 border-r border-black">SERIAL</div>
                            <div className="w-1/4 p-1">LOCATION OF UNIT</div>
                            <div className="w-8 no-print"></div>
                        </div>
                        {units.map((unit, index) => (
                            <div key={unit.id} className={`flex text-sm ${index > 0 ? 'border-t border-black' : ''} relative group`}>
                                <input value={unit.unitNo} onChange={(e) => handleUnitChange(unit.id, 'unitNo', e.target.value)} className="w-1/6 p-1 border-r border-black bg-blue-50 print:bg-transparent outline-none" />
                                <input value={unit.make} onChange={(e) => handleUnitChange(unit.id, 'make', e.target.value)} className="w-1/6 p-1 border-r border-black bg-blue-50 print:bg-transparent outline-none" />
                                <input value={unit.model} onChange={(e) => handleUnitChange(unit.id, 'model', e.target.value)} className="w-1/6 p-1 border-r border-black bg-blue-50 print:bg-transparent outline-none" />
                                <input value={unit.serial} onChange={(e) => handleUnitChange(unit.id, 'serial', e.target.value)} className="w-1/4 p-1 border-r border-black bg-blue-50 print:bg-transparent outline-none" />
                                <input value={unit.location} onChange={(e) => handleUnitChange(unit.id, 'location', e.target.value)} className="w-1/4 p-1 bg-blue-50 print:bg-transparent outline-none" placeholder="(Store Name)" />
                                <div className="w-8 flex items-center justify-center no-print border-l border-black bg-white">
                                    <button onClick={() => removeUnit(unit.id)} className="text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={14} /></button>
                                </div>
                            </div>
                        ))}
                        <button onClick={addUnit} className="w-full py-1 text-center text-blue-600 text-xs font-bold hover:bg-blue-50 no-print border-t border-black border-dashed">+ Add Unit</button>
                    </div>

                    {/* Technician Info */}
                    <div className="mb-4 border border-black">
                        <div className="flex bg-gray-200 text-xs font-bold border-b border-black print:bg-gray-100">
                            <div className="w-1/4 p-1 border-r border-black">TECHNICIAN</div>
                            <div className="w-1/4 p-1 border-r border-black">EN ROUTE</div>
                            <div className="w-1/4 p-1 border-r border-black">CLOCK IN</div>
                            <div className="w-1/4 p-1">CLOCK OUT</div>
                            <div className="w-8 no-print"></div>
                        </div>
                        {technicians.map((tech, index) => (
                            <div key={tech.id} className={`flex text-sm ${index > 0 ? 'border-t border-black' : ''} relative group`}>
                                <input value={tech.name} onChange={(e) => handleTechChange(tech.id, 'name', e.target.value)} className="w-1/4 p-1 border-r border-black bg-blue-50 print:bg-transparent outline-none" />
                                <input type="time" value={tech.enRoute} onChange={(e) => handleTechChange(tech.id, 'enRoute', e.target.value)} className="w-1/4 p-1 border-r border-black bg-blue-50 print:bg-transparent outline-none" />
                                <input type="time" value={tech.clockIn} onChange={(e) => handleTechChange(tech.id, 'clockIn', e.target.value)} className="w-1/4 p-1 border-r border-black bg-blue-50 print:bg-transparent outline-none" />
                                <input type="time" value={tech.clockOut} onChange={(e) => handleTechChange(tech.id, 'clockOut', e.target.value)} className="w-1/4 p-1 bg-blue-50 print:bg-transparent outline-none" />
                                <div className="w-8 flex items-center justify-center no-print border-l border-black bg-white">
                                    <button onClick={() => removeTech(tech.id)} className="text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={14} /></button>
                                </div>
                            </div>
                        ))}
                        <button onClick={addTech} className="w-full py-1 text-center text-blue-600 text-xs font-bold hover:bg-blue-50 no-print border-t border-black border-dashed">+ Add Technician</button>
                    </div>

                    {/* Description */}
                    <div className="mb-4 border border-black">
                        <div className="bg-gray-200 text-xs font-bold p-1 border-b border-black print:bg-gray-100">
                            {docType === 'invoice' ? 'DESCRIPTION OF WORK' : 'SCOPE OF WORK / PROPOSAL DETAILS'}
                        </div>
                        <textarea value={descriptionOfWork} onChange={(e) => setDescriptionOfWork(e.target.value)} className="w-full h-32 p-2 text-sm bg-blue-50 print:bg-transparent outline-none resize-y" />
                    </div>

                    {/* Materials */}
                    <div className="mb-4">
                        <div className="flex bg-gray-200 text-xs font-bold border border-black print:bg-gray-100">
                            <div className="w-16 p-1 border-r border-black text-center">QTY</div>
                            <div className="flex-1 p-1 border-r border-black">DESCRIPTION</div>
                            <div className="w-24 p-1 text-right border-r border-black">PRICE</div>
                            <div className="w-24 p-1 text-right">AMOUNT</div>
                            <div className="w-8 no-print"></div>
                        </div>
                        {items.map((item) => (
                            <div key={item.id} className="flex border-b border-l border-r border-black text-sm">
                            <input type="number" value={item.qty} onChange={(e) => handleItemChange(item.id, 'qty', parseFloat(e.target.value) || 0)} className="w-16 p-1 border-r border-black text-center bg-blue-50 print:bg-transparent outline-none" />
                            <input type="text" value={item.description} onChange={(e) => handleItemChange(item.id, 'description', e.target.value)} className="flex-1 p-1 border-r border-black bg-blue-50 print:bg-transparent outline-none" />
                            <input type="number" value={item.price} onChange={(e) => handleItemChange(item.id, 'price', parseFloat(e.target.value) || 0)} className="w-24 p-1 border-r border-black text-right bg-blue-50 print:bg-transparent outline-none" />
                            <div className="w-24 p-1 text-right bg-gray-50 print:bg-transparent">{ (item.qty * item.price).toFixed(2) }</div>
                            <div className="w-8 flex items-center justify-center no-print">
                                <button onClick={() => removeItem(item.id)} className="text-red-500 hover:text-red-700"><Trash2 size={14} /></button>
                            </div>
                            </div>
                        ))}
                        <button onClick={addItem} className="mt-2 flex items-center gap-1 text-blue-600 text-xs font-bold hover:underline no-print"><Plus size={14} /> Add Item</button>
                    </div>

                    {/* Totals */}
                    <div className="flex mb-4 gap-4 print-break-inside-avoid">
                        <div className="flex-1 border border-black flex flex-col">
                            <div className="bg-gray-200 text-xs font-bold p-1 border-b border-black print:bg-gray-100">RECOMMENDATIONS</div>
                            <textarea value={recommendations} onChange={(e) => setRecommendations(e.target.value)} className="w-full flex-1 p-2 text-sm bg-blue-50 print:bg-transparent outline-none resize-y" />
                        </div>
                        <div className="w-64 border border-black text-sm">
                            <div className="flex justify-between p-2 border-b border-black"><span className="font-bold">SUBTOTAL</span><span>${subtotal.toFixed(2)}</span></div>
                            <div className="flex justify-between p-2 border-b border-black bg-gray-50 print:bg-transparent"><span className="font-bold">TAX RATE</span><input type="number" step="0.01" value={taxRate} onChange={(e) => setTaxRate(parseFloat(e.target.value))} className="w-12 text-right bg-blue-50 print:bg-transparent outline-none" /></div>
                            <div className="flex justify-between p-2 border-b border-black"><span className="font-bold">TAX</span><span>${tax.toFixed(2)}</span></div>
                            <div className="flex justify-between p-2 font-bold bg-gray-200 print:bg-gray-100"><span>TOTAL</span><span>${total.toFixed(2)}</span></div>
                        </div>
                    </div>

                    {/* Attachments */}
                    <div className="mb-6 border border-black p-2 print-break-inside-avoid">
                        <div className="flex justify-between items-center mb-2">
                            <div className="text-xs font-bold">PHOTOS & ATTACHMENTS</div>
                            <div className="no-print">
                                <input type="file" multiple accept="image/*,application/pdf" onChange={handleFileSelect} ref={fileInputRef} className="hidden" id="file-upload" />
                                <label htmlFor="file-upload" className="flex items-center gap-1 text-blue-600 text-xs font-bold hover:underline cursor-pointer"><Paperclip size={14} /> Add Photo/PDF</label>
                            </div>
                        </div>
                        
                        {attachments.length === 0 ? (
                            <div className="text-xs text-gray-400 italic p-2 text-center border-t border-gray-100">No attachments</div>
                        ) : (
                            <div className="grid grid-cols-2 gap-4 mt-2">
                                {attachments.map(att => (
                                    <div key={att.id} className="relative group border border-gray-200 p-1 hover:shadow-md transition-shadow">
                                        {att.type.startsWith('image/') ? (
                                            <a href={att.data} target="_blank" rel="noopener noreferrer" className="block cursor-pointer" title="Click to view full image"><img src={att.data} alt="Attachment" className="w-full h-48 object-contain" /></a>
                                        ) : (
                                            <a href={att.data} target="_blank" rel="noopener noreferrer" className="block w-full h-48 flex flex-col items-center justify-center bg-gray-50 text-blue-600 hover:bg-blue-50 transition-colors cursor-pointer" title="Click to open PDF">
                                                <FileText size={32} />
                                                <span className="text-xs mt-2 text-center break-all px-2 font-bold underline">{att.name}</span>
                                                <div className="flex items-center gap-1 text-[10px] text-gray-500 mt-1"><ExternalLink size={10} /><span>Click to Open PDF</span></div>
                                            </a>
                                        )}
                                        <button onClick={(e) => { e.preventDefault(); removeAttachment(att.id); }} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity no-print z-10" title="Remove attachment"><Trash2 size={12} /></button>
                                    </div>
                                ))}
                            </div>
                        )}
                        <div className="mt-2 text-[9px] text-gray-400 no-print">* Note: Attachments are included in the PDF Print as links/images, but are not saved to the cloud database to save space.</div>
                    </div>

                    {/* Footer */}
                    <div className="text-[10px] leading-tight text-justify text-gray-600 mb-6">
                        <p className="mb-2 font-bold">{TEXTS.warrantyTitle}</p>
                        <p>{TEXTS.warrantyBody}</p>
                    </div>

                    {/* Acknowledgment */}
                    <div className="border border-black p-2 flex items-end gap-4 print-break-inside-avoid">
                        <div className="flex-1 text-[10px] leading-tight">
                            <p className="font-bold mb-1">{TEXTS.ackTitle}</p>
                            <p>{TEXTS.ackBody}</p>
                        </div>
                        <div className="w-1/3 border-t border-black pt-1">
                            <div className="text-xs font-bold mb-8">PRINT NAME</div>
                            <div className="text-xs font-bold border-t border-black pt-1">SIGNATURE</div>
                        </div>
                    </div>
                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<InvoiceApp />);
    </script>
</body>
</html>
